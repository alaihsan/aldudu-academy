<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ quiz.name }} - Aldudu Academy</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='quiz_editor.css') }}">
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLFe8MWR+I" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container">
        <div class="quiz-header-nav">
            <a href="{{ url_for('main.course_detail', course_id=course.id) }}" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                    <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                </svg>
                Kembali ke {{ course.name }}
            </a>
        </div>

        <div class="quiz-title-container">
            <h1>{{ quiz.name }}</h1>
            <p class="quiz-sub-info">Diselenggarakan oleh <strong>{{ course.teacher.name }}</strong> di kelas <strong>{{ course.name }}</strong></p>
        </div>

        {% if is_teacher %}
        <div class="teacher-controls">
            <select id="question-type-select" name="question_type" class="question-type-selector">
                <option value="MULTIPLE_CHOICE" selected>Pilihan Ganda</option>
                <option value="TRUE_FALSE">Benar/Salah</option>
                <option value="LONG_TEXT">Esai Singkat</option>
            </select>
            <button
                class="btn-add-question"
                hx-post="/api/quiz/{{ quiz.id }}/question/add"
                hx-include="#question-type-select"
                hx-target="#question-list"
                hx-swap="beforeend"
                hx-indicator="#loading-spinner">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Tambah Pertanyaan
            </button>
            <span id="loading-spinner" class="htmx-indicator">Menyimpan...</span>
        </div>
        {% endif %}

        <div id="question-list">
            {% for question in questions %}
                {% if is_teacher %}
                    {% include '_question_form.html' %}
                {% else %}
                    {% with loop_index = loop.index %}{% include '_question_student.html' %}{% endwith %}
                {% endif %}
            {% endfor %}
        </div>

        {% if not quiz.questions.all() and is_teacher %}
            <div class="placeholder-empty-quiz">
                <h3>Kuis Ini Masih Kosong</h3>
                <p>Tambahkan pertanyaan pertama menggunakan tombol "Tambah Pertanyaan" di atas.</p>
            </div>
        {% endif %}

        {% if not is_teacher and questions %}
        <div class="student-submit-area">
            <button id="submit-quiz-btn" class="btn-submit-quiz">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                    <path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.949a.75.75 0 00.95.53l4.424-1.265a.75.75 0 01.53.95l-1.265 4.424a.75.75 0 00.53.95l4.949 1.414a.75.75 0 00.95-.826l-2.289-7.999a.75.75 0 00-.95-.53l-7.999 2.289z" />
                </svg>
                Kirim Semua Jawaban
            </button>
        </div>
        {% endif %}
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const submitBtn = document.getElementById('submit-quiz-btn');
        if (submitBtn) {
            submitBtn.addEventListener('click', function () {
                submitQuiz();
            });
        }
    });

    function submitQuiz() {
        const answers = [];
        const questionCards = document.querySelectorAll('.question-card-student');

        questionCards.forEach(card => {
            const questionId = parseInt(card.dataset.questionId);
            const questionType = card.dataset.questionType;

            if (questionType === 'MULTIPLE_CHOICE' || questionType === 'TRUE_FALSE') {
                const selectedOption = card.querySelector(`input[name="question_${questionId}"]:checked`);
                if (selectedOption) {
                    answers.push({
                        question_id: questionId,
                        selected_option_id: parseInt(selectedOption.value)
                    });
                }
            } else if (questionType === 'LONG_TEXT') {
                const answerText = card.querySelector(`textarea[name="question_${questionId}"]`).value.trim();
                if (answerText) {
                    answers.push({
                        question_id: questionId,
                        answer_text: answerText
                    });
                }
            }
        });

        if (answers.length < questionCards.length) {
            Swal.fire({
                icon: 'warning',
                title: 'Belum Selesai',
                text: 'Anda belum menjawab semua pertanyaan. Apakah Anda yakin ingin mengirimnya?',
                showCancelButton: true,
                confirmButtonText: 'Ya, Kirim Saja',
                cancelButtonText: 'Batal',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
            }).then((result) => {
                if (result.isConfirmed) {
                    sendAnswers(answers);
                }
            });
        } else {
            sendAnswers(answers);
        }
    }

    function sendAnswers(answers) {
        Swal.fire({
            title: 'Mengirim Jawaban...',
            text: 'Harap tunggu sebentar.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        fetch(`/api/quiz/{{ quiz.id }}/submit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ answers: answers })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Kuis Terkirim!',
                    html: `Skor Anda: <strong>${data.score.toFixed(1)}%</strong><br>(${data.correct_answers} dari ${data.total_questions} jawaban benar)`,
                    confirmButtonText: 'Kembali ke Kelas'
                }).then(() => {
                    window.location.href = "{{ url_for('main.course_detail', course_id=course.id) }}";
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: data.message || 'Terjadi kesalahan saat mengirim jawaban.'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Kesalahan Jaringan',
                text: 'Tidak dapat terhubung ke server. Silakan coba lagi nanti.'
            });
        });
    }
    </script>
</body>
</html>
