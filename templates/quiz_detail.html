<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ quiz.name }} - Aldudu Academy</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- 1. Memuat HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10" xintegrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLFe8MWR+I" crossorigin="anonymous"></script>
</head>
<body>

    <div id="app-page">
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <a href="{{ url_for('main.dashboard') }}" class="header-logo">Aldudu Academy</a>
                </div>
                <div class="header-right">
                    <a href="{{ url_for('main.course_detail', course_id=course.id) }}" class="btn-link">
                        &larr; Kembali ke {{ course.name }}
                    </a>
                </div>
            </div>
        </header>

        <main class="container">

            <div class="quiz-header">
                <div class="quiz-header-content">
                    <div class="quiz-title-section">
                        <h1 class="quiz-title">{{ quiz.name }}</h1>
                        <div class="quiz-meta">
                            <span class="quiz-course">{{ course.name }}</span>
                            <span class="quiz-separator">•</span>
                            <span class="quiz-teacher">{{ course.teacher.name }}</span>
                        </div>
                    </div>
                    {% if is_teacher %}
                    <div class="quiz-actions">
                        <a href="{{ url_for('main.course_detail', course_id=course.id) }}" class="btn btn-secondary">
                            ← Kembali ke Kelas
                        </a>
                    </div>
                    {% endif %}
                </div>

                <div class="quiz-description">
                    {% if is_teacher %}
                    <div class="description-card teacher-card">
                        <div class="description-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v-1.5a.75.75 0 011.5 0v1.5h.75a.75.75 0 010 1.5h-.75v1.5a.75.75 0 01-1.5 0v-1.5H9a.75.75 0 010-1.5h.75z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 12a4 4 0 100-8 4 4 0 000 8zm0 2c-2.67 0-8 1.34-8 4v2a1 1 0 001 1h14a1 1 0 001-1v-2c0-2.66-5.33-4-8-4z" />
                            </svg>
                        </div>
                        <div class="description-content">
                            <h3>Kelola Pertanyaan</h3>
                            <p>Semua perubahan disimpan otomatis. Gunakan tombol di bawah untuk menambah pertanyaan baru.</p>
                        </div>
                    </div>
                    {% else %}
                    <div class="description-card student-card">
                        <div class="description-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <div class="description-content">
                            <h3>Jawab Pertanyaan</h3>
                            <p>Jawab semua pertanyaan di bawah ini dengan teliti. Pastikan untuk mengirim jawaban sebelum waktu habis.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 2. Kontrol kuis (hanya untuk guru) -->
            {% if is_teacher %}
            <div class="quiz-controls">
                <select id="question-type-select" name="question_type" class="form-input" style="width: auto;">
                    <option value="MULTIPLE_CHOICE" selected>Pilihan Ganda</option>
                    <option value="TRUE_FALSE">Benar/Salah</option>
                    <option value="LONG_TEXT">Long Text</option>
                </select>
                <button
                    class="btn btn-primary"
                    hx-post="/api/quiz/{{ quiz.id }}/question/add"
                    hx-include="#question-type-select"
                    hx-target="#question-list"
                    hx-swap="beforeend"
                    hx-indicator="#loading-spinner">

                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 18px; height: 18px; margin-right: 0.5rem; transform: translateY(2px);">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    Buat Pertanyaan Baru
                </button>
                <span id="loading-spinner" class="htmx-indicator" style="margin-left: 1rem;">
                    Menyimpan...
                </span>
            </div>
            {% endif %}

            <!-- 3. Daftar pertanyaan (target HTMX) -->
            <div class="question-list-container">
                <div id="question-list">

                    <!-- 4. Render pertanyaan yang sudah ada saat halaman dimuat -->
                    {% for question in questions %}
                        {% if is_teacher %}
                            {% include '_question_form.html' %}
                        {% else %}
                            {% include '_question_student.html' %}
                        {% endif %}
                    {% endfor %}

                </div>
                 {% if not quiz.questions.all() and is_teacher %}
                    <div class="content-placeholder" style="text-align: center; padding: 3rem; border: 2px dashed var(--border-color); border-radius: 12px;">
                        <p style="font-size: 1.1rem; color: var(--text-secondary-color);">Belum ada pertanyaan.</p>
                        <p style="color: var(--text-secondary-color);">Klik tombol "Buat Pertanyaan Baru" di atas untuk memulai.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Submit button for students -->
            {% if not is_teacher and questions %}
            <div class="quiz-submit-section">
                <div class="submit-container">
                    <div class="submit-info">
                        <div class="submit-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                            </svg>
                        </div>
                        <div class="submit-text">
                            <h3>Siap Mengirim Jawaban?</h3>
                            <p>Pastikan semua pertanyaan telah dijawab dengan benar sebelum mengirim.</p>
                        </div>
                    </div>
                    <div class="submit-actions">
                        <button id="submit-quiz-btn" class="btn btn-primary btn-large" onclick="submitQuiz()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px; margin-right: 8px;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                            </svg>
                            Kirim Jawaban
                        </button>
                    </div>
                </div>

                <div id="submit-status" class="submit-status" style="display: none;">
                    <div class="status-content">
                        <div class="status-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <p id="submit-message"></p>
                    </div>
                </div>
            </div>
            {% endif %}

        </main>
    </div>

    <script src="{{ url_for('static', filename='js/quiz_student.js') }}"></script>

    <script>
        function submitQuiz() {
            const answers = [];

            // Collect answers from the form
            const questionCards = document.querySelectorAll('.question-card');
            questionCards.forEach(card => {
                const questionId = parseInt(card.dataset.questionId);
                const questionType = card.dataset.questionType;

                if (questionType === 'MULTIPLE_CHOICE' || questionType === 'TRUE_FALSE') {
                    const selectedOption = card.querySelector(`input[name="question_${questionId}"]:checked`);
                    if (selectedOption) {
                        answers.push({
                            question_id: questionId,
                            selected_option_id: parseInt(selectedOption.value)
                        });
                    }
                } else if (questionType === 'LONG_TEXT') {
                    const answerText = card.querySelector(`textarea[name="question_${questionId}"]`).value.trim();
                    if (answerText) {
                        answers.push({
                            question_id: questionId,
                            answer_text: answerText
                        });
                    }
                }
            });

            if (answers.length === 0) {
                alert('Silakan jawab setidaknya satu pertanyaan sebelum mengirim.');
                return;
            }

            const submitBtn = document.getElementById('submit-quiz-btn');
            const statusDiv = document.getElementById('submit-status');
            const messageP = document.getElementById('submit-message');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Mengirim...';
            statusDiv.style.display = 'block';
            messageP.textContent = 'Sedang mengirim jawaban...';

            fetch(`/api/quiz/{{ quiz.id }}/submit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ answers: answers })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageP.textContent = `Kuis berhasil dikirim! Skor Anda: ${data.score.toFixed(1)}% (${data.correct_answers}/${data.total_questions} benar)`;
                    messageP.style.color = 'green';
                    submitBtn.style.display = 'none';
                } else {
                    messageP.textContent = 'Error: ' + data.message;
                    messageP.style.color = 'red';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Kirim Jawaban';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageP.textContent = 'Terjadi kesalahan saat mengirim. Silakan coba lagi.';
                messageP.style.color = 'red';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Kirim Jawaban';
            });
        }
    </script>

</body>
</html>
